# 项目结构说明

本文档详细说明项目的代码组织结构、各模块职责和关键文件说明。

## 目录结构

```
emo-voice-chat/
├── src/                          # 源代码目录
│   ├── app/                      # 应用主流程
│   │   ├── __init__.py
│   │   ├── main.py              # 命令行入口
│   │   └── pipeline.py          # 核心处理流程
│   ├── audio/                    # 音频处理工具
│   │   ├── __init__.py
│   │   ├── record.py            # 录音功能
│   │   ├── player.py            # 音频播放
│   │   └── utils.py             # 音频工具函数
│   ├── config/                   # 配置管理
│   │   ├── __init__.py
│   │   └── settings.py          # 全局配置（ROOT_DIR等）
│   ├── context/                  # 对话历史管理
│   │   ├── __init__.py
│   │   ├── config.py            # 历史配置（最大轮数、目录等）
│   │   ├── history.py           # 对话历史管理器
│   │   └── schemas.py           # 数据结构定义
│   ├── llm/                      # 大语言模型模块
│   │   ├── __init__.py
│   │   ├── llm_engine.py        # LLM 引擎统一接口
│   │   ├── prompt_builder.py    # Prompt 构建器
│   │   └── backends/            # LLM 后端实现
│   │       ├── __init__.py
│   │       ├── config.py        # LLM 配置
│   │       ├── hf_transformers_backend.py  # Transformers 后端
│   │       └── llama_cpp_backend.py        # llama.cpp 后端
│   ├── ser/                      # 情绪识别模块（当前与STT集成）
│   │   ├── __init__.py
│   │   ├── config.py
│   │   ├── schemas.py           # 情绪标签枚举
│   │   └── ser_engine.py        # SER 引擎（预留）
│   ├── stt/                      # 语音转文字模块
│   │   ├── __init__.py
│   │   ├── config.py
│   │   ├── sensevoice_engine.py # SenseVoice 引擎（STT+SER）
│   │   └── whisper_engine.py   # Whisper 引擎（备选）
│   ├── tts/                      # 语音合成模块
│   │   ├── __init__.py
│   │   ├── config.py            # TTS 配置（后端选择、情绪参数等）
│   │   ├── tts_engine.py        # TTS 引擎统一接口
│   │   ├── indextts_backend.py  # IndexTTS 后端
│   │   ├── coqui_backend.py     # Coqui TTS 后端
│   │   └── vits_backend.py      # VITS 后端
│   ├── utils/                    # 工具函数
│   │   ├── __init__.py
│   │   ├── device.py            # 设备管理
│   │   ├── path_setup.py        # 路径设置
│   │   ├── timing.py            # 时间工具
│   │   └── voice_transform.py   # 语音转换
│   └── tests/                    # 测试脚本
│       ├── sensevoice_demo.py
│       ├── llm_demo.py
│       ├── tts_demo.py
│       └── ...
├── data/                         # 数据目录
│   ├── history/                 # 对话历史文件（user_*.json）
│   ├── input/                   # 输入音频（命令行使用）
│   ├── output_voice/            # TTS 输出音频（按用户ID组织）
│   └── web_input/              # Web 上传的音频（按用户ID组织）
├── configs/                      # 配置文件（YAML格式，部分模块使用）
│   ├── base.yaml
│   └── ...
├── web_service.py               # FastAPI Web 服务入口
├── index.html                   # Web 前端界面
├── requirements.txt             # Python 依赖列表
├── README.md                    # 项目说明文档
├── 操作手册.md                  # 详细操作指南
├── 技术栈文档.md                # 技术栈说明
└── 项目结构说明.md             # 本文档
```

## 核心模块详解

### 1. `src/app/` - 应用主流程

**职责**：整合所有模块，实现完整的语音对话流程

#### `main.py`
- **功能**：命令行入口
- **主要代码**：调用 `run_chat_loop()` 启动交互式对话

#### `pipeline.py`
- **功能**：核心处理流程
- **关键函数**：
  - `run_one_turn()`: 单轮对话（录音 → STT → LLM → TTS → 播放）
  - `run_one_turn_from_wav_with_result()`: 从音频文件处理（Web服务使用）
  - `run_chat_loop()`: 交互式对话循环
  - `_map_sensevoice_emotion_to_label()`: 情绪标签映射

**数据流**：
```
音频输入 → STT+SER → 文本+情绪 → LLM → 回复文本+情绪 → TTS → 音频输出
```

---

### 2. `src/stt/` - 语音转文字模块

**职责**：将语音转换为文本，同时识别情绪

#### `sensevoice_engine.py`
- **类**：`SenseVoiceEngine`
- **功能**：
  - 加载 SenseVoice 模型
  - 转写音频为文本
  - 提取情绪标签（HAPPY/SAD/ANGRY/NEUTRAL）
  - 识别语言
- **返回**：`SenseVoiceResult` (text, emotion, language)

#### `whisper_engine.py`
- **类**：`WhisperEngine`
- **功能**：备选 STT 引擎（当前主要使用 SenseVoice）

**使用示例**：
```python
stt = SenseVoiceEngine()
result = stt.transcribe("audio.wav")
print(result.text)      # 文本
print(result.emotion)   # 情绪标签
```

---

### 3. `src/llm/` - 大语言模型模块

**职责**：根据用户输入、情绪和对话历史生成智能回复

#### `llm_engine.py`
- **类**：`LLMEngine`
- **功能**：统一的 LLM 接口
- **方法**：
  - `generate_reply()`: 生成回复
  - `unload()`: 卸载模型（释放显存）

#### `prompt_builder.py`
- **类**：`PromptBuilder`
- **功能**：构建包含情绪策略和对话历史的 Prompt
- **方法**：
  - `build_prompt()`: 构建字符串格式 Prompt
  - `build_chat_messages()`: 构建 ChatML 格式 messages（用于 Qwen）

#### `backends/hf_transformers_backend.py`
- **类**：`HFTransformersBackend`
- **功能**：使用 Transformers + BitsAndBytes 实现 LLM 推理
- **特性**：支持 4-bit/8-bit 量化

#### `backends/llama_cpp_backend.py`
- **类**：`LlamaCppBackend`
- **功能**：使用 llama.cpp 实现 LLM 推理
- **特性**：支持 CPU 推理，显存占用更低

**使用示例**：
```python
llm = LLMEngine()
reply = llm.generate_reply(
    user_text="你好",
    user_emotion=EmotionLabel.NEUTRAL,
    history=recent_turns
)
```

---

### 4. `src/tts/` - 语音合成模块

**职责**：将文本转换为匹配情绪的语音

#### `tts_engine.py`
- **类**：`TTSEngine`
- **功能**：统一的 TTS 接口
- **方法**：
  - `synthesize()`: 合成语音
  - `unload()`: 卸载模型

#### `config.py`
- **功能**：TTS 配置
- **关键配置**：
  - `DEFAULT_BACKEND`: 默认后端（indextts/coqui/vits）
  - `EMOTION_TTS_MAPPING`: 情绪到TTS参数的映射
  - `INDEXTTS_SERVICE_URL`: IndexTTS 服务地址

#### `indextts_backend.py`
- **类**：`IndexTTSBackend`
- **功能**：通过 HTTP 调用 IndexTTS 服务
- **特性**：支持情绪语音合成

#### `coqui_backend.py`
- **类**：`CoquiTTSBackend`
- **功能**：使用 Coqui TTS 库合成语音
- **模型**：`tts_models/zh-CN/emotion-tts/vits`

**使用示例**：
```python
tts = TTSEngine(backend_type="indextts")
audio_path = tts.synthesize(
    text="你好",
    emotion=EmotionLabel.HAPPY,
    speaker_wav="reference.wav"
)
```

---

### 5. `src/context/` - 对话历史管理

**职责**：管理多用户的对话历史

#### `history.py`
- **类**：`ConversationHistory`
- **功能**：
  - 加载/保存对话历史（JSON格式）
  - 添加对话轮次
  - 获取最近N轮对话
  - 清空历史
- **存储位置**：`data/history/user_*.json`

#### `schemas.py`
- **类**：`ConversationTurn`
- **功能**：定义对话轮次的数据结构
- **字段**：
  - `turn_id`: 轮次ID
  - `user_id`: 用户ID
  - `user_text`: 用户文本
  - `user_emotion`: 用户情绪
  - `assistant_reply`: 助手回复
  - `timestamp`: 时间戳

#### `config.py`
- **配置项**：
  - `MAX_HISTORY_TURNS`: 最大保留轮数（默认10）
  - `HISTORY_DIR`: 历史文件目录

**使用示例**：
```python
history = ConversationHistory(user_id="user_001")
history.add_turn(
    user_text="你好",
    user_emotion=EmotionLabel.NEUTRAL,
    assistant_reply="你好呀！"
)
recent = history.get_recent_turns(n=5)
```

---

### 6. `src/audio/` - 音频处理工具

**职责**：音频录制和播放

#### `record.py`
- **类**：`Recorder`
- **功能**：录音（支持静音自动停止）

#### `player.py`
- **函数**：`play_wav()`
- **功能**：播放音频文件

---

### 7. `src/ser/` - 情绪识别模块

**职责**：情绪识别（当前与STT集成，此模块为预留）

#### `schemas.py`
- **枚举**：`EmotionLabel`
- **值**：`HAPPY`, `SAD`, `ANGRY`, `NEUTRAL`

**注意**：当前情绪识别由 SenseVoice 完成，此模块主要用于定义数据结构。

---

### 8. `src/config/` - 配置管理

**职责**：全局配置

#### `settings.py`
- **变量**：`ROOT_DIR` - 项目根目录路径

---

## Web 服务

### `web_service.py`

**职责**：FastAPI Web 服务，提供 HTTP API

**主要功能**：
1. **用户管理**：
   - `generate_user_id()`: 生成用户ID
   - `get_or_create_user_id()`: 获取或创建用户ID
   - `delete_user_data()`: 删除用户数据

2. **音频处理**：
   - `convert_to_wav()`: 音频格式转换（webm/ogg → wav）

3. **API 端点**：
   - `GET /`: 返回前端页面
   - `POST /api/voice-chat`: 语音对话接口
   - `DELETE /api/clear-history`: 清除历史接口

**全局引擎实例**：
- `stt`: SenseVoiceEngine
- `llm`: LLMEngine
- `tts`: TTSEngine

**数据目录**：
- `data/web_input/`: Web上传的音频（按用户ID组织）
- `data/output_voice/`: TTS输出音频（按用户ID组织）

---

## 前端

### `index.html`

**功能**：Web 前端界面

**主要特性**：
- 录音功能（Web Audio API）
- 实时对话历史显示
- 情绪标签显示
- 音频播放
- 清除历史功能

**技术**：
- HTML5 + CSS3
- JavaScript (原生，无框架)
- Web Audio API
- Fetch API

---

## 数据流

### 完整流程

```
1. 用户输入（语音）
   ↓
2. web_service.py: 接收上传文件
   ↓
3. convert_to_wav(): 格式转换
   ↓
4. pipeline.run_one_turn_from_wav_with_result():
   ├─→ stt.transcribe(): STT + SER
   │   └─→ 返回: (text, emotion)
   │
   ├─→ history.get_recent_turns(): 获取历史
   │
   ├─→ llm.generate_reply(): 生成回复
   │   └─→ prompt_builder.build_chat_messages(): 构建Prompt
   │   └─→ 返回: JSON {"replay": "...", "emotion": "..."}
   │
   ├─→ history.add_turn(): 保存历史
   │
   └─→ tts.synthesize(): 合成语音
       └─→ 返回: 音频文件路径
   ↓
5. web_service.py: 读取音频 → base64编码
   ↓
6. 返回 JSON 响应给前端
   ↓
7. 前端播放音频
```

---

## 关键设计模式

### 1. 统一接口模式

每个模块都有统一的接口类：
- `STTEngine` (抽象) → `SenseVoiceEngine` (实现)
- `LLMEngine` (统一接口) → `HFTransformersBackend` / `LlamaCppBackend`
- `TTSEngine` (统一接口) → `IndexTTSBackend` / `CoquiTTSBackend`

### 2. 配置分离

- 环境变量配置
- 代码配置（config.py）
- YAML 配置文件（部分模块）

### 3. 数据持久化

- 对话历史：JSON 文件
- 音频文件：按用户ID组织目录

### 4. 错误处理

- 显存不足：明确的错误提示和建议
- 模型加载失败：优雅降级或报错
- API 错误：HTTP 状态码 + 错误信息

---

## 扩展指南

### 添加新的 STT 后端

1. 在 `src/stt/` 创建新文件，实现 `transcribe()` 方法
2. 返回格式：`(text, emotion, language)`

### 添加新的 LLM 后端

1. 在 `src/llm/backends/` 创建新后端类
2. 实现 `generate()` 或 `generate_from_messages()` 方法
3. 在 `LLMEngine` 中注册新后端

### 添加新的 TTS 后端

1. 在 `src/tts/` 创建新后端类
2. 实现 `synthesize()` 方法
3. 在 `TTSEngine` 中注册新后端

### 添加新的情绪类型

1. 在 `src/ser/schemas.py` 的 `EmotionLabel` 枚举中添加
2. 在 `src/tts/config.py` 的 `EMOTION_TTS_MAPPING` 中添加映射
3. 在 `src/llm/prompt_builder.py` 中添加情绪策略

---

## 代码规范

### 命名规范

- **类名**：大驼峰（`SenseVoiceEngine`）
- **函数名**：小写下划线（`run_one_turn`）
- **常量**：大写下划线（`MAX_HISTORY_TURNS`）
- **私有方法**：单下划线前缀（`_load`）

### 文档字符串

所有公共类和方法都应包含 docstring：

```python
def function_name(param: str) -> str:
    """
    函数说明
    
    :param param: 参数说明
    :return: 返回值说明
    """
    pass
```

### 类型提示

尽量使用类型提示：

```python
from typing import Optional, List

def process(text: str, emotion: Optional[EmotionLabel] = None) -> List[str]:
    pass
```

---

## 测试

### 单元测试

各模块的测试脚本位于 `src/tests/`：

- `sensevoice_demo.py`: 测试 STT
- `llm_demo.py`: 测试 LLM
- `tts_demo.py`: 测试 TTS

### 集成测试

- 命令行模式：`python -m src.app.main`
- Web 模式：启动服务后访问 `http://localhost:8001`

---

## 维护建议

### 日志记录

- 使用 `print()` 输出关键信息
- 错误信息包含上下文
- 建议未来集成 `loguru` 库

### 性能监控

- 记录各模块处理时间
- 监控显存使用情况
- 记录 API 响应时间

### 代码审查

- 定期检查依赖版本更新
- 关注安全漏洞
- 优化显存占用

---

**最后更新**：2024年

如有问题或建议，请提交 Issue 或 Pull Request。

