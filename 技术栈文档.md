# 技术栈文档

本文档详细说明项目使用的所有框架、库和工具，便于学习和维护。

## 目录

1. [核心框架](#核心框架)
2. [深度学习库](#深度学习库)
3. [语音处理](#语音处理)
4. [Web 框架](#web-框架)
5. [音频处理](#音频处理)
6. [工具库](#工具库)
7. [版本兼容性](#版本兼容性)

## 核心框架

### PyTorch

**版本**：2.4.0  
**用途**：深度学习框架，所有模型的基础运行环境

**关键组件**：
- `torch`: 核心张量计算库
- `torchvision`: 计算机视觉工具
- `torchaudio`: 音频处理工具

**CUDA 支持**：
- 使用 CUDA 12.1 版本
- 通过 `--extra-index-url` 安装 CUDA 版本

**相关文件**：
- `requirements.txt`: 指定版本和 CUDA 索引

**学习资源**：
- [PyTorch 官方文档](https://pytorch.org/docs/stable/index.html)
- [PyTorch 教程](https://pytorch.org/tutorials/)

---

## 深度学习库

### Transformers (Hugging Face)

**版本**：4.46.0  
**用途**：加载和运行预训练模型（LLM、SER等）

**关键功能**：
- 模型加载：`AutoModel`, `AutoTokenizer`
- 量化支持：4-bit/8-bit 量化
- 生成接口：`generate()` 方法

**使用位置**：
- `src/llm/backends/hf_transformers_backend.py`: LLM 推理
- `src/stt/sensevoice_engine.py`: SenseVoice 模型加载

**相关配置**：
```python
from transformers import AutoModel, AutoTokenizer
model = AutoModel.from_pretrained(
    model_name,
    load_in_4bit=True,  # 4-bit 量化
    device_map="auto"
)
```

**学习资源**：
- [Transformers 文档](https://huggingface.co/docs/transformers)
- [模型库](https://huggingface.co/models)

### BitsAndBytes

**版本**：>=0.41.0,<0.43.0  
**用途**：实现 4-bit/8-bit 量化，降低显存占用

**关键功能**：
- `load_in_4bit=True`: 4-bit 量化加载
- `load_in_8bit=True`: 8-bit 量化加载

**使用位置**：
- `src/llm/backends/hf_transformers_backend.py`: LLM 量化加载

**优势**：
- 显存占用减少 75%（4-bit）或 50%（8-bit）
- 推理速度基本不变

**学习资源**：
- [BitsAndBytes GitHub](https://github.com/TimDettmers/bitsandbytes)

### Accelerate

**版本**：0.34.0  
**用途**：简化多GPU/混合精度训练和推理

**关键功能**：
- 自动设备分配
- 混合精度支持
- 分布式训练

**使用位置**：
- 被 Transformers 内部使用
- 模型自动设备分配

**学习资源**：
- [Accelerate 文档](https://huggingface.co/docs/accelerate)

---

## 语音处理

### FunASR (SenseVoice)

**版本**：1.3.0  
**用途**：语音识别（STT）+ 情绪识别（SER）

**关键功能**：
- `AutoModel`: 自动加载 SenseVoice 模型
- `generate()`: 转写音频并提取情绪标签
- 支持多语言（中文、英文等）

**使用位置**：
- `src/stt/sensevoice_engine.py`: STT + SER 引擎

**模型信息**：
- 模型名称：`iic/SenseVoiceSmall`
- 来源：ModelScope
- 显存占用：约 1GB

**输出格式**：
```python
{
    "text": "你好",
    "emotion": "HAPPY",  # HAPPY/SAD/ANGRY/NEUTRAL
    "language": "zh"
}
```

**学习资源**：
- [FunASR GitHub](https://github.com/alibaba-damo-academy/FunASR)
- [ModelScope](https://modelscope.cn/models/iic/SenseVoiceSmall)

### OpenAI Whisper

**版本**：20240927  
**用途**：备选 STT 引擎（当前主要使用 SenseVoice）

**关键功能**：
- 高精度语音识别
- 多语言支持
- 支持长音频

**使用位置**：
- `src/stt/whisper_engine.py`: Whisper 引擎封装

**学习资源**：
- [Whisper GitHub](https://github.com/openai/whisper)

---

## 大语言模型

### Qwen2.5-7B-Instruct

**模型信息**：
- 参数量：7B
- 量化：4-bit
- 显存占用：约 6GB（4-bit量化后）

**使用位置**：
- `src/llm/backends/hf_transformers_backend.py`: 模型加载和推理
- `src/llm/prompt_builder.py`: Prompt 构建

**Prompt 格式**：
- 使用 ChatML 格式
- 包含系统提示、对话历史、用户输入和情绪标签

**生成参数**：
```python
{
    "max_new_tokens": 512,
    "temperature": 0.7,
    "top_p": 0.9,
    "do_sample": False
}
```

**学习资源**：
- [Qwen GitHub](https://github.com/QwenLM/Qwen)
- [模型卡片](https://huggingface.co/Qwen/Qwen2.5-7B-Instruct)

### Llama.cpp (可选后端)

**用途**：CPU 推理或更高效的 GPU 推理

**使用位置**：
- `src/llm/backends/llama_cpp_backend.py`: Llama.cpp 后端封装

**优势**：
- 更低的显存占用
- 支持 CPU 推理
- 更快的推理速度（某些场景）

**学习资源**：
- [llama.cpp GitHub](https://github.com/ggerganov/llama.cpp)

---

## 语音合成 (TTS)

### IndexTTS

**用途**：主要 TTS 后端，支持情绪语音合成

**部署方式**：
- 独立 HTTP 服务
- 默认地址：`http://localhost:8000/tts`

**使用位置**：
- `src/tts/indextts_backend.py`: IndexTTS 后端封装

**模型信息**：
- 模型：IndexTTS-2
- 来源：ModelScope
- 支持情绪：happy, sad, angry, neutral

**API 调用**：
```python
POST /tts
{
    "text": "你好",
    "emotion": "happy",
    "speaker_wav": "base64_audio"
}
```

**学习资源**：
- [IndexTTS ModelScope](https://modelscope.cn/models/IndexTeam/IndexTTS-2)

### Coqui TTS

**版本**：0.22.0  
**用途**：备选 TTS 后端

**模型信息**：
- 默认模型：`tts_models/zh-CN/emotion-tts/vits`
- 支持情绪语音合成

**使用位置**：
- `src/tts/coqui_backend.py`: Coqui TTS 后端封装

**学习资源**：
- [Coqui TTS GitHub](https://github.com/coqui-ai/TTS)
- [模型库](https://github.com/coqui-ai/TTS/wiki/Released-Models)

### VITS (可选)

**用途**：轻量级 TTS 后端

**使用位置**：
- `src/tts/vits_backend.py`: VITS 后端封装

---

## Web 框架

### FastAPI

**版本**：0.128.0  
**用途**：构建 RESTful API 服务

**关键功能**：
- 自动 API 文档生成
- 类型验证（Pydantic）
- 异步支持
- CORS 中间件

**使用位置**：
- `web_service.py`: 主服务文件

**主要端点**：
```python
@app.get("/")                    # 前端页面
@app.post("/api/voice-chat")      # 语音对话
@app.delete("/api/clear-history") # 清除历史
```

**学习资源**：
- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [FastAPI 教程](https://fastapi.tiangolo.com/tutorial/)

### Uvicorn

**版本**：0.39.0  
**用途**：ASGI 服务器，运行 FastAPI 应用

**启动命令**：
```bash
uvicorn web_service:app --host 0.0.0.0 --port 8001
```

**学习资源**：
- [Uvicorn 文档](https://www.uvicorn.org/)

---

## 音频处理

### PyAudio

**版本**：0.2.14  
**用途**：录音和播放音频

**关键功能**：
- `Recorder`: 录音类
- `play_wav()`: 播放音频文件

**使用位置**：
- `src/audio/record.py`: 录音功能
- `src/audio/player.py`: 播放功能

**学习资源**：
- [PyAudio 文档](https://people.csail.mit.edu/hubert/pyaudio/docs/)

### SoundFile

**版本**：0.13.1  
**用途**：读取和写入音频文件

**关键功能**：
- `soundfile.read()`: 读取音频
- `soundfile.write()`: 写入音频

**使用位置**：
- 各模块的音频 I/O 操作

### Librosa

**版本**：0.10.0  
**用途**：音频分析和处理

**关键功能**：
- 音频特征提取
- 音频格式转换
- 音频预处理

**使用位置**：
- TTS 模块的音频处理

**学习资源**：
- [Librosa 文档](https://librosa.org/doc/latest/index.html)

### PyDub

**版本**：0.25.1  
**用途**：音频操作和格式转换

**关键功能**：
- 音频格式转换
- 音频剪切和拼接

**使用位置**：
- 音频预处理和转换

---

## 工具库

### Pydantic

**版本**：>=2.0.0,<3.0.0  
**用途**：数据验证和序列化

**使用位置**：
- `src/context/schemas.py`: 对话数据结构
- `src/ser/schemas.py`: 情绪标签枚举
- FastAPI 请求/响应验证

**学习资源**：
- [Pydantic 文档](https://docs.pydantic.dev/)

### NumPy

**版本**：1.22.0  
**用途**：数值计算基础库

**使用位置**：
- 所有深度学习模块的底层计算

### SciPy

**版本**：1.11.4  
**用途**：科学计算库

**使用位置**：
- 音频信号处理

### TQDM

**版本**：>=4.66.0  
**用途**：进度条显示

**使用位置**：
- 模型下载和加载过程

### Requests

**版本**：>=2.31.0  
**用途**：HTTP 请求库

**使用位置**：
- IndexTTS HTTP 服务调用
- 模型下载

### Hugging Face Hub

**版本**：>=0.19.0  
**用途**：从 Hugging Face 下载模型

**使用位置**：
- 模型自动下载

---

## 版本兼容性

### Python 版本

- **推荐**：Python 3.9 或 3.10
- **最低**：Python 3.8
- **不兼容**：Python 3.11+（某些包可能不兼容）

### CUDA 版本

- **推荐**：CUDA 11.8 或 12.0+
- **PyTorch 支持**：CUDA 12.1（通过 pip 安装）

### 操作系统

- **推荐**：Ubuntu 22.04 LTS
- **支持**：Ubuntu 20.04+, CentOS 7+, Windows 10+（部分功能）

### 依赖版本冲突

**常见问题**：

1. **NumPy 版本**：
   - TTS 0.22.0 要求 numpy<2.0.0
   - 当前使用：numpy==1.22.0

2. **Transformers 版本**：
   - 需要 >=4.35.0,<5.0.0
   - 当前使用：4.46.0

3. **BitsAndBytes 版本**：
   - 需要 >=0.41.0,<0.43.0
   - 注意：新版本可能有兼容性问题

### 版本锁定建议

**生产环境**：
- 使用 `requirements.txt` 锁定所有版本
- 避免使用 `>=` 或 `~=` 等宽松版本约束

**开发环境**：
- 可以适当放宽版本约束
- 定期测试新版本兼容性

---

## 学习路径建议

### 初学者

1. **基础**：
   - Python 基础语法
   - 深度学习基础（PyTorch）
   - RESTful API 概念

2. **进阶**：
   - Transformers 库使用
   - 模型量化和优化
   - 音频处理基础

3. **实践**：
   - 阅读项目代码
   - 运行测试脚本
   - 修改配置参数

### 进阶学习

1. **模型理解**：
   - SenseVoice 架构
   - Qwen 模型原理
   - TTS 模型原理

2. **优化技巧**：
   - 显存优化
   - 推理加速
   - 批量处理

3. **扩展开发**：
   - 添加新的 TTS 后端
   - 支持新的情绪类型
   - 优化 Prompt 工程

---

## 参考资源

### 官方文档

- [PyTorch](https://pytorch.org/docs/stable/index.html)
- [Transformers](https://huggingface.co/docs/transformers)
- [FastAPI](https://fastapi.tiangolo.com/)
- [FunASR](https://github.com/alibaba-damo-academy/FunASR)

### 模型仓库

- [Hugging Face](https://huggingface.co/)
- [ModelScope](https://modelscope.cn/)

### 社区资源

- [PyTorch 论坛](https://discuss.pytorch.org/)
- [Hugging Face 社区](https://discuss.huggingface.co/)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/pytorch)

---

**最后更新**：2024年

如有技术问题，请参考各框架的官方文档或提交 Issue。

